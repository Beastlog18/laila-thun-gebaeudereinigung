<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jobs – Laila Thun Gebäudereinigung</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<header class="header">
  <img src="img/Logo.png" class="header-logo" alt="Logo">

  <div class="brand-header">
    <div class="brand-line1">LAILA THUN</div>
    <div class="brand-line2">GEBÄUDEREINIGUNG</div>
    <div class="brand-divider"></div>
  </div>

  <nav class="nav">
    <a href="index.html">Home</a>
    <a href="ueber-uns.html">Über uns</a>
    <a href="leistungen.html">Leistungen</a>
    <a href="kontakt.html">Kontakt</a>
    <a href="jobs.html" class="active">Jobs</a>
  </nav>
</header>

<section class="section">
  <h1 class="page-title">Jobs</h1>

  <p class="page-intro">
    Wir wachsen – bewusst und Schritt für Schritt.
    Um unsere gewerblichen Kunden zuverlässig betreuen zu können,
    bauen wir unser Team weiter aus.
    <br><br>
    Wenn du zuverlässig bist, sauber arbeitest und gern im direkten Kontakt mit Menschen stehst,
    bist du bei uns richtig. Erfahrung ist hilfreich, aber kein Muss – wichtig ist,
    dass es menschlich passt.
  </p>

  <!-- DYNAMISCHE JOBS (LIVE via Supabase) -->
  <div id="jobsDynamic" class="service-grid"></div>

  <!-- INITIATIVBEWERBUNG – IMMER SICHTBAR -->
  <div class="service-grid mt-20">
    <div class="service-card" style="grid-column: 1 / -1;">
      <h3>Initiativbewerbung (m/w/d)</h3>

      <p class="mt-10 text-muted">
        Wir arbeiten überwiegend im <strong>südlichen Berlin</strong> sowie im <strong>Berliner Umland</strong> –
        unter anderem in <strong>Großbeeren</strong>, <strong>Wildau</strong>,
        <strong>Schulzendorf</strong> und rund um <strong>Königs Wusterhausen</strong>.
        Bei passenden Anfragen sind auch andere Regionen möglich.
      </p>

      <p class="mt-14">
        Auch wenn gerade keine konkrete Stelle ausgeschrieben ist,
        freuen wir uns jederzeit über Menschen, die zu uns passen.
        <br><br>
        Sag uns einfach kurz, wann du verfügbar bist, in welcher Region du arbeiten möchtest
        und ob du bereits Erfahrung in der Reinigung hast.
      </p>

      <ul class="about-list mt-14">
        <li>Zuverlässige Einarbeitung und feste Absprachen</li>
        <li>Persönlicher Kontakt – kein anonymer Großbetrieb</li>
        <li>Einsatzzeiten nach Absprache</li>
        <li>Langfristige Zusammenarbeit gewünscht</li>
      </ul>

      <div class="mt-16">
        <button class="btn btn-primary" type="button" data-apply="Initiativbewerbung (m/w/d)">Jetzt bewerben</button>
      </div>
    </div>
  </div>

  <!-- BEWERBUNGSFORMULAR (einblendbar, keine neue Seite) -->
  <div id="applicationWrap" class="service-grid mt-20" hidden>
    <div class="service-card" style="grid-column: 1 / -1;">
      <h3 id="applicationTitle">Bewerbung</h3>

      <p class="mt-10 text-muted" id="applicationSubtitle">
        Bitte fülle das Formular aus. Wir melden uns zeitnah zurück.
      </p>

      <form id="applicationForm" class="mt-14">
        <input type="hidden" id="appJobTitle" name="job_title" value="">

        <div class="mt-10">
          <label class="text-small"><strong>Name *</strong></label><br>
          <input id="appName" type="text" required autocomplete="name" style="width:100%;max-width:640px;">
        </div>

        <div class="mt-10">
          <label class="text-small"><strong>E-Mail *</strong></label><br>
          <input id="appEmail" type="email" required autocomplete="email" style="width:100%;max-width:640px;">
        </div>

        <div class="mt-10">
          <label class="text-small"><strong>Telefon</strong></label><br>
          <input id="appPhone" type="tel" autocomplete="tel" style="width:100%;max-width:640px;">
        </div>

        <div class="mt-10">
          <label class="text-small"><strong>Region / Ort</strong></label><br>
          <input id="appRegion" type="text" placeholder="z. B. Königs Wusterhausen / Wildau / Berlin" style="width:100%;max-width:640px;">
        </div>

        <div class="mt-10">
          <label class="text-small"><strong>Verfügbarkeit</strong></label><br>
          <input id="appAvailability" type="text" placeholder="z. B. ab sofort, vormittags, abends, 2–3 Tage/Woche" style="width:100%;max-width:640px;">
        </div>

        <div class="mt-10">
          <label class="text-small"><strong>Nachricht *</strong></label><br>
          <textarea id="appMessage" required rows="6" style="width:100%;max-width:900px;"></textarea>
        </div>

        <div class="mt-14">
          <button id="appSubmitBtn" class="btn btn-primary" type="submit">Bewerbung absenden</button>
          <button id="appCloseBtn" class="btn" type="button">Schließen</button>
        </div>

        <p id="appStatus" class="mt-14 text-small text-muted" style="display:none;"></p>
      </form>
    </div>
  </div>

</section>

<footer class="footer">
  <div>© 2026 Laila Thun Gebäudereinigung · Konzept &amp; Gestaltung: Mayk Freund</div>
  <div class="footer-links">
    <a href="impressum.html">Impressum</a>
    <span>·</span>
    <a href="datenschutz.html">Datenschutz</a>
  </div>
</footer>

<!-- 1) Supabase Client (setzt window.LTGSupabase) -->
<script src="/api/supabase.client.js"></script>

<!-- 2) Jobs API (setzt window.JobsAPI) -->
<script src="/api/jobs.api.js"></script>

<!-- 3) LIVE Jobs + Bewerbung (UI) -->
<script>
  (function () {
    "use strict";

    function typeLabel(type) {
      if (type === "minijob") return "Minijob";
      if (type === "teilzeit") return "Teilzeit";
      if (type === "vollzeit") return "Vollzeit";
      return type || "-";
    }

    function buildMeta(job) {
      const parts = [];
      if (job.type) parts.push(typeLabel(job.type));
      if (job.hours) parts.push(job.hours + " Std./Woche");
      if (job.location) parts.push(job.location);
      if (!job.location && job.region) parts.push(job.region); // defensiv
      return parts.join(" · ");
    }

    function splitPreview(preview) {
      const lines = String(preview || "").split("\n");
      return lines.slice(3).join("\n").trim();
    }

    function buildFallbackText(job) {
      const blocks = [];
      const tasks = String(job.tasks || "").trim();
      const req = String(job.requirements || "").trim();
      const ben = String(job.benefits || job.weOffer || "").trim();

      if (tasks) blocks.push("Aufgaben:\n" + tasks);
      if (req) blocks.push("Anforderungen:\n" + req);
      if (ben) blocks.push("Wir bieten:\n" + ben);

      return blocks.join("\n\n").trim();
    }

    // ---- Bewerbung UI ----
    const wrap = document.getElementById("applicationWrap");
    const form = document.getElementById("applicationForm");
    const titleEl = document.getElementById("applicationTitle");
    const subtitleEl = document.getElementById("applicationSubtitle");
    const jobTitleInput = document.getElementById("appJobTitle");

    const nameEl = document.getElementById("appName");
    const emailEl = document.getElementById("appEmail");
    const phoneEl = document.getElementById("appPhone");
    const regionEl = document.getElementById("appRegion");
    const availEl = document.getElementById("appAvailability");
    const msgEl = document.getElementById("appMessage");

    const submitBtn = document.getElementById("appSubmitBtn");
    const closeBtn = document.getElementById("appCloseBtn");
    const statusEl = document.getElementById("appStatus");

    function showStatus(text, isError) {
      if (!statusEl) return;
      statusEl.style.display = "block";
      statusEl.textContent = text;
      statusEl.style.color = isError ? "#7f1d1d" : "";
    }

    function openApplication(jobTitle) {
      const jt = String(jobTitle || "Initiativbewerbung").trim();
      if (wrap) wrap.hidden = false;

      if (titleEl) titleEl.textContent = "Bewerbung";
      if (subtitleEl) subtitleEl.textContent = "Stelle: " + jt;

      if (jobTitleInput) jobTitleInput.value = jt;

      if (statusEl) {
        statusEl.style.display = "none";
        statusEl.textContent = "";
      }

      setTimeout(() => {
        wrap.scrollIntoView({ behavior: "smooth", block: "start" });
        if (nameEl) nameEl.focus();
      }, 50);
    }

    function closeApplication() {
      if (wrap) wrap.hidden = true;
      if (form) form.reset();
      if (jobTitleInput) jobTitleInput.value = "";
      if (statusEl) {
        statusEl.style.display = "none";
        statusEl.textContent = "";
      }
    }

    document.addEventListener("click", (e) => {
      const t = e.target;
      if (!t) return;

      const btn = t.closest && t.closest("[data-apply]");
      if (btn) {
        e.preventDefault();
        openApplication(btn.getAttribute("data-apply"));
      }
    });

    if (closeBtn) closeBtn.addEventListener("click", closeApplication);

    // ---- Jobs rendern ----
    function renderJobs(jobs) {
      const dyn = document.getElementById("jobsDynamic");
      if (!dyn) return;

      const published = (jobs || []).filter(j => j && (j.published === true || j.published === "true"));

      if (!published.length) {
        dyn.style.display = "none";
        return;
      }

      dyn.style.display = "grid";
      dyn.innerHTML = "";

      published.forEach(job => {
        const card = document.createElement("div");
        card.className = "service-card";
        card.style.gridColumn = "1 / -1";

        const meta = buildMeta(job);
        const safeTitle = job.title ? String(job.title) : "Stellenangebot";
        const bodyText = job.preview ? splitPreview(job.preview) : buildFallbackText(job);

        card.innerHTML = `
          <h3>${safeTitle}</h3>
          ${meta ? `<p>${meta}</p>` : ""}
          ${bodyText ? `<pre class="mt-14" style="white-space:pre-wrap;font-family:inherit;">${bodyText}</pre>` : ""}
          <div class="mt-14">
            <button class="btn btn-primary" type="button" data-apply="${safeTitle}">Jetzt bewerben</button>
          </div>
        `;

        dyn.appendChild(card);
      });
    }

    async function init() {
      try {
        if (!window.LTGSupabase || typeof window.LTGSupabase.ensureClient !== "function") {
          throw new Error("Supabase Client nicht verfügbar (/api/supabase.client.js nicht geladen).");
        }
        await window.LTGSupabase.ensureClient();

        if (!window.JobsAPI || typeof window.JobsAPI.getPublishedJobs !== "function") {
          throw new Error("JobsAPI nicht verfügbar (/api/jobs.api.js nicht geladen).");
        }

        const jobs = await window.JobsAPI.getPublishedJobs();
        renderJobs(jobs);

        if (form) {
          form.addEventListener("submit", async (ev) => {
            ev.preventDefault();

            const payload = {
              job_title: (jobTitleInput && jobTitleInput.value ? jobTitleInput.value : "Initiativbewerbung").trim(),
              name: (nameEl && nameEl.value ? nameEl.value : "").trim(),
              email: (emailEl && emailEl.value ? emailEl.value : "").trim(),
              phone: (phoneEl && phoneEl.value ? phoneEl.value : "").trim(),
              region: (regionEl && regionEl.value ? regionEl.value : "").trim(),
              availability: (availEl && availEl.value ? availEl.value : "").trim(),
              message: (msgEl && msgEl.value ? msgEl.value : "").trim(),
              source: "jobs.html",
              created_at: new Date().toISOString()
            };

            if (!payload.name || !payload.email || !payload.message) {
              showStatus("Bitte fülle Name, E-Mail und Nachricht aus.", true);
              return;
            }

            submitBtn.disabled = true;
            const oldText = submitBtn.textContent;
            submitBtn.textContent = "Wird gesendet...";

            try {
              await window.JobsAPI.submitApplication(payload);
              showStatus("Vielen Dank! Deine Bewerbung wurde gesendet. Wir melden uns zeitnah.", false);
              form.reset();
              if (jobTitleInput) jobTitleInput.value = payload.job_title;
            } catch (err) {
              showStatus("Senden fehlgeschlagen. Bitte versuche es später erneut oder nutze die Kontaktseite.", true);
            } finally {
              submitBtn.disabled = false;
              submitBtn.textContent = oldText;
            }
          });
        }
      } catch (e) {
        const dyn = document.getElementById("jobsDynamic");
        if (dyn) dyn.style.display = "none";
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  })();
</script>

</body>
</html>
